#!/usr/bin/env node
var phantom = require('phantom');
var config = require('../config/config');
var hash = process.argv[2];

var sitepage = null;
var phInstance = null;

phantom.create()
.then(function(instance) {
    phInstance = instance;
    return instance.createPage();
})
.then(function(page) {
    sitepage = page;
    page.addCookie({
	  'name'     : hash,   /* required property */
	  'value'    : 'yes',  /* required property */
	  'domain'   : config.domain,
	  'path'     : '/',                /* required property */
	  'expires'  : (new Date()).getTime() + (1000 * 60 * 60)   /* <-- expires in 1 hour */
	});
	return page.open(config.url+'/vote/'+hash);
})
.then(function(status) {
    return sitepage.property('content');
})
.then(function(content) {
	return sitepage.evaluate(function() {
			    return $('canvas')[0].toDataURL('image/png', 0);
			})
})
.then(function(image) {
	base64Img.imgSync(image, config.imagesPath, hash);

    sitepage.close();
	phInstance.exit();
})
.catch(function(error) {
    phInstance.exit();
});